name: Deploy with ServiceNow

on:
  workflow_dispatch:

jobs:
  create:
    uses: raghav1674/servicenow-cr-automation/.github/actions/servicenow/action.yml@main
    secrets:
      hmac_token: ${{ secrets.SNOW_HMAC }}
    with:
      action: create
      instance: dev198952.service-now.com
      body: '{"short_description":"Deploy release 1.2.3","type": "Normal"}'

  wait:
    needs: create
    uses: raghav1674/servicenow-cr-automation/.github/actions/servicenow/action.yml@main
    secrets:
      hmac_token: ${{ secrets.SNOW_HMAC }}
    with:
      action: wait
      instance: dev198952.service-now.com
      cr_id: ${{ needs.create.outputs.cr_id }}
      timeout_minutes: 30

  close:
    needs: wait
    uses: raghav1674/servicenow-cr-automation/.github/actions/servicenow/action.yml@main
    secrets:
      hmac_token: ${{ secrets.SNOW_HMAC }}
    with:
      action: close
      instance: dev198952.service-now.com
      cr_id: ${{ needs.create.outputs.cr_id }}
